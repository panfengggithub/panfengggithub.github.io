(window.webpackJsonp=window.webpackJsonp||[]).push([[470],{884:function(_,e,t){"use strict";t.r(e);var v=t(1),s=Object(v.a)({},(function(){var _=this,e=_._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[e("h1",{attrs:{id:"ç§’æ€ç³»ç»Ÿé«˜å¹¶å‘åœºæ™¯ä¸‹æ‰£åº“å­˜"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ç§’æ€ç³»ç»Ÿé«˜å¹¶å‘åœºæ™¯ä¸‹æ‰£åº“å­˜"}},[_._v("#")]),_._v(" "),e("strong",[_._v("ç§’æ€ç³»ç»Ÿé«˜å¹¶å‘åœºæ™¯ä¸‹æ‰£åº“å­˜")])]),_._v(" "),e("h1",{attrs:{id:"_1-ä¸‹å•çš„ä¸šåŠ¡æµç¨‹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-ä¸‹å•çš„ä¸šåŠ¡æµç¨‹"}},[_._v("#")]),_._v(" 1.ä¸‹å•çš„ä¸šåŠ¡æµç¨‹")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370433-94e55f55-f048-4372-8d6d-ba05cd5768da.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("ul",[e("li",[e("p",[e("strong",[_._v("è®¢å•ç¡®è®¤")])])]),_._v(" "),e("li",[e("p",[e("strong",[_._v("ç”Ÿæˆè®¢å•")])])]),_._v(" "),e("li",[e("p",[e("strong",[_._v("æ”¯ä»˜äºŒç»´ç ")])])]),_._v(" "),e("li",[e("p",[e("strong",[_._v("æ‰«ç æ”¯ä»˜")])])]),_._v(" "),e("li",[e("p",[e("strong",[_._v("ç¡®è®¤æ”¯ä»˜")])])]),_._v(" "),e("li",[e("p",[e("strong",[_._v("å›è°ƒæ›´æ–°è®¢å•çŠ¶æ€")])])]),_._v(" "),e("li",[e("p",[e("strong",[_._v("è®¢å•æŸ¥è¯¢")])])])]),_._v(" "),e("h1",{attrs:{id:"_2-å‡åº“å­˜æ–¹å¼"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-å‡åº“å­˜æ–¹å¼"}},[_._v("#")]),_._v(" 2.å‡åº“å­˜æ–¹å¼")]),_._v(" "),e("p",[_._v("å‡åº“å­˜æœ‰3ç§æ–¹å¼")]),_._v(" "),e("ul",[e("li",[e("p",[_._v("ä¸‹å•å‡åº“å­˜ï¼Œå³å½“ä¹°å®¶ä¸‹å•åï¼Œåœ¨å•†å“çš„æ€»åº“å­˜ä¸­å‡å»ä¹°å®¶è´­ä¹°æ•°é‡ã€‚ä¸‹å•å‡åº“å­˜æ˜¯æœ€ç®€å•çš„å‡åº“å­˜æ–¹å¼ï¼Œä¹Ÿæ˜¯æ§åˆ¶æœ€ç²¾ç¡®çš„ä¸€ç§ï¼Œä¸‹å•æ—¶ç›´æ¥é€šè¿‡æ•°æ®åº“çš„äº‹åŠ¡æœºåˆ¶æ§åˆ¶å•†å“åº“å­˜ï¼Œè¿™æ ·ä¸€å®šä¸ä¼šå‡ºç°è¶…å–çš„æƒ…å†µã€‚ä½†æ˜¯ä½ è¦çŸ¥é“ï¼Œæœ‰äº›äººä¸‹å®Œå•å¯èƒ½å¹¶ä¸ä¼šä»˜æ¬¾ã€‚")])]),_._v(" "),e("li",[e("p",[_._v("ä»˜æ¬¾å‡åº“å­˜ï¼Œå³ä¹°å®¶ä¸‹å•åï¼Œå¹¶ä¸ç«‹å³å‡åº“å­˜ï¼Œè€Œæ˜¯ç­‰åˆ°æœ‰ç”¨æˆ·ä»˜æ¬¾åæ‰çœŸæ­£å‡åº“å­˜ï¼Œå¦åˆ™åº“å­˜ä¸€ç›´ä¿ç•™ç»™å…¶ä»–ä¹°å®¶ã€‚ä½†å› ä¸ºä»˜æ¬¾æ—¶æ‰å‡åº“å­˜ï¼Œå¦‚æœå¹¶å‘æ¯”è¾ƒé«˜ï¼Œæœ‰å¯èƒ½å‡ºç°ä¹°å®¶ä¸‹å•åä»˜ä¸äº†æ¬¾çš„æƒ…å†µï¼Œå› ä¸ºå¯èƒ½å•†å“å·²ç»è¢«å…¶ä»–äººä¹°èµ°äº†ã€‚")])]),_._v(" "),e("li",[e("p",[_._v("é¢„æ‰£åº“å­˜ï¼Œè¿™ç§æ–¹å¼ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œä¹°å®¶ä¸‹å•åï¼Œåº“å­˜ä¸ºå…¶ä¿ç•™ä¸€å®šçš„æ—¶é—´ï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œåº“å­˜å°†ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œé‡Šæ”¾åå…¶ä»–ä¹°å®¶å°±å¯ä»¥ç»§ç»­è´­ä¹°ã€‚åœ¨ä¹°å®¶ä»˜æ¬¾å‰ï¼Œç³»ç»Ÿä¼šæ ¡éªŒè¯¥è®¢å•çš„åº“å­˜æ˜¯å¦è¿˜æœ‰ä¿ç•™ï¼šå¦‚æœæ²¡æœ‰ä¿ç•™ï¼Œåˆ™å†æ¬¡å°è¯•é¢„æ‰£ï¼›å¦‚æœåº“å­˜ä¸è¶³ï¼ˆä¹Ÿå°±æ˜¯é¢„æ‰£å¤±è´¥ï¼‰åˆ™ä¸å…è®¸ç»§ç»­ä»˜æ¬¾ï¼›å¦‚æœé¢„æ‰£æˆåŠŸï¼Œåˆ™å®Œæˆä»˜æ¬¾å¹¶å®é™…åœ°å‡å»åº“å­˜ã€‚")])])]),_._v(" "),e("h1",{attrs:{id:"_3-ç§’æ€ç³»ç»Ÿå‡åº“å­˜"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-ç§’æ€ç³»ç»Ÿå‡åº“å­˜"}},[_._v("#")]),_._v(" 3.ç§’æ€ç³»ç»Ÿå‡åº“å­˜")]),_._v(" "),e("p",[_._v("ä¸‹å•å‡åº“å­˜ åœ¨æ•°æ®ä¸€è‡´æ€§ä¸Šï¼Œä¸»è¦å°±æ˜¯ä¿è¯å¤§å¹¶å‘è¯·æ±‚æ—¶åº“å­˜æ•°æ®ä¸èƒ½ä¸ºè´Ÿæ•°ã€‚")]),_._v(" "),e("h2",{attrs:{id:"_3-1-æ‚²è§‚é”"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-æ‚²è§‚é”"}},[_._v("#")]),_._v(" 3.1 æ‚²è§‚é”")]),_._v(" "),e("p",[_._v("ç›´æ¥åœ¨ç§’æ€åº“å­˜è¡¨åŠ è¡Œé”")]),_._v(" "),e("p",[_._v("BEGIN;")]),_._v(" "),e("p",[_._v("SELECT * FROM "),e("code",[_._v("sms_flash_promotion_product_relation")]),_._v(" WHERE id=38 for UPDATE;")]),_._v(" "),e("p",[_._v("UPDATE sms_flash_promotion_product_relation set flash_promotion_count=flash_promotion_count-1 where id=38;")]),_._v(" "),e("p",[_._v("COMMIT;")]),_._v(" "),e("p",[_._v("ROLLBACK;")]),_._v(" "),e("p",[_._v("Integer dbStock = miaoShaStockDao.selectMiaoShaStockInLock(product.getFlashPromotionRelationId());")]),_._v(" "),e("p",[_._v("if(dbStock <= 0){")]),_._v(" "),e("p",[_._v('return CommonResult.failed("å•†å“å·²æŠ¢å®Œï¼");')]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("miaoShaStockDao.descStockInLock(product.getFlashPromotionRelationId(),dbStock-1);")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370431-3f9a30ab-e6a0-40a0-a285-15cf78e24024.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[_._v("é—®é¢˜ï¼š")]),_._v(" "),e("p",[e("strong",[_._v("å¤§é‡è¯·æ±‚å¯¼è‡´æ•°æ®åº“è¿æ¥è¢«è€—å°½ï¼Œæ•°æ®åº“å´©æºƒã€‚")])]),_._v(" "),e("p",[e("strong",[_._v("ç‰¹æ®Šæƒ…å†µä¸‹ä¼šæ­»é”")])]),_._v(" "),e("h2",{attrs:{id:"_3-2-ä¹è§‚é”"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-ä¹è§‚é”"}},[_._v("#")]),_._v(" 3.2 ä¹è§‚é”")]),_._v(" "),e("h3",{attrs:{id:"_3-2-1-è·å–ç‰ˆæœ¬å·-æ›´æ–°æ—¶æ¯”è¾ƒç‰ˆæœ¬"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-è·å–ç‰ˆæœ¬å·-æ›´æ–°æ—¶æ¯”è¾ƒç‰ˆæœ¬"}},[_._v("#")]),_._v(" 3.2.1 è·å–ç‰ˆæœ¬å·ï¼Œæ›´æ–°æ—¶æ¯”è¾ƒç‰ˆæœ¬")]),_._v(" "),e("p",[_._v("BEGIN;")]),_._v(" "),e("p",[_._v("SELECT version,* FROM "),e("code",[_._v("sms_flash_promotion_product_relation")]),_._v(" WHERE id=38 for UPDATE;")]),_._v(" "),e("p",[_._v("UPDATE sms_flash_promotion_product_relation set flash_promotion_count=flash_promotion_count-1 ,version =version +1 where id=38 and version=#{version};")]),_._v(" "),e("p",[_._v("COMMIT;")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370429-435d68a4-ed2b-40d8-b3bf-6d14d354c80f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370457-3a92b443-3e67-44a9-bbd4-257ebc338058.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("h3",{attrs:{id:"_3-2-2-è®¾ç½®åº“å­˜å­—æ®µä¸ºæ— ç¬¦å·æ•´å½¢"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-è®¾ç½®åº“å­˜å­—æ®µä¸ºæ— ç¬¦å·æ•´å½¢"}},[_._v("#")]),_._v(" 3.2.2  è®¾ç½®åº“å­˜å­—æ®µä¸ºæ— ç¬¦å·æ•´å½¢")]),_._v(" "),e("p",[_._v("è®¾ç½®æ— ç¬¦å·æ•´å½¢ï¼Œç›®çš„æ˜¯é˜²æ­¢å‡ºç°è´Ÿæ•°ã€‚å¦‚æœå‡ºç°è´Ÿæ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚å¦åˆ™ä¹Ÿä¼šå‡ºç°è¶…å–çš„æƒ…å†µ")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370492-581cf1f6-cd47-45cf-905e-0f0b1712ace2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_37%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[_._v("æ•°æ®åº“æ¯æ¬¡æ‰§è¡Œä¸€æ¡updateè¯­å¥æ—¶ä¼šè·å–è¢«updateè¡Œçš„å†™é”ï¼Œç›´åˆ°è¿™ä¸€è¡Œè¢«æˆåŠŸæ›´æ–°åæ‰é‡Šæ”¾ã€‚å› æ­¤åœ¨ä¸šåŠ¡æ“ä½œè¿›è¡Œå‰è·å–éœ€è¦é”çš„æ•°æ®çš„å½“å‰ç‰ˆæœ¬å·ï¼Œç„¶åå®é™…æ›´æ–°æ•°æ®æ—¶å†æ¬¡å¯¹æ¯”ç‰ˆæœ¬å·ç¡®è®¤ä¸ä¹‹å‰è·å–çš„ç›¸åŒï¼Œå¹¶æ›´æ–°ç‰ˆæœ¬å·ï¼Œå³å¯ç¡®è®¤è¿™ä¹‹é—´æ²¡æœ‰å‘ç”Ÿå¹¶å‘çš„ä¿®æ”¹ã€‚å¦‚æœæ›´æ–°å¤±è´¥å³å¯è®¤ä¸ºè€ç‰ˆæœ¬çš„æ•°æ®å·²ç»è¢«å¹¶å‘ä¿®æ”¹æ‰è€Œä¸å­˜åœ¨äº†ï¼Œæ­¤æ—¶è®¤ä¸ºè·å–é”å¤±è´¥ï¼Œéœ€è¦å›æ»šæ•´ä¸ªä¸šåŠ¡æ“ä½œå¹¶å¯æ ¹æ®éœ€è¦é‡è¯•æ•´ä¸ªè¿‡ç¨‹ã€‚")]),_._v(" "),e("p",[e("strong",[_._v("æ€»ç»“")])]),_._v(" "),e("ul",[e("li",[_._v("ä¹è§‚é”åœ¨ä¸å‘ç”Ÿå–é”å¤±è´¥çš„æƒ…å†µä¸‹å¼€é”€æ¯”æ‚²è§‚é”å°ï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå¤±è´¥å›æ»šå¼€é”€åˆ™æ¯”è¾ƒå¤§ï¼Œå› æ­¤é€‚åˆç”¨åœ¨å–é”å¤±è´¥æ¦‚ç‡æ¯”è¾ƒå°çš„åœºæ™¯ï¼Œå¯ä»¥æå‡ç³»ç»Ÿå¹¶å‘æ€§èƒ½")]),_._v(" "),e("li",[e("strong",[_._v("ä¹è§‚é”ä¼šå‡ºç°ä¸å…¬å¹³ç°è±¡ï¼Œäº§ç”Ÿå¤§é‡çš„æ—¥å¿—")])])]),_._v(" "),e("h2",{attrs:{id:""}},[e("a",{staticClass:"header-anchor",attrs:{href:"#"}},[_._v("#")])]),_._v(" "),e("h2",{attrs:{id:"_3-3-case-whenæœºåˆ¶"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-case-whenæœºåˆ¶"}},[_._v("#")]),_._v(" "),e("strong",[_._v("3.3 Case Whenæœºåˆ¶")])]),_._v(" "),e("p",[_._v("UPDATE sms_flash_promotion_product_relation SET flash_promotion_count = CASE WHEN flash_promotion_count >= 20 THEN flash_promotion_count-20 ELSE flash_promotion_count END where id=38;")]),_._v(" "),e("p",[_._v("int resultDb = miaoShaStockDao.descStock(product.getFlashPromotionRelationId(),1);")]),_._v(" "),e("ol",[e("li",[_._v("é¢„å‡åº“å­˜")])]),_._v(" "),e("p",[_._v("æå‰æ ¡éªŒåº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå‡å°‘ç›´æ¥è®¿é—®DBçš„æµé‡ã€‚")]),_._v(" "),e("p",[_._v("é—®é¢˜ï¼š100ä¸ªäººæŠ¢1ä¸ªåº“å­˜ï¼Œéœ€è¦è®¿é—®DBå—ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370427-b13a963f-756a-49f2-808b-cc2c8f344d62.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_21%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("h2",{attrs:{id:"_5-1-é¢„å‡åº“å­˜è§£å†³æ–¹æ¡ˆ"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-é¢„å‡åº“å­˜è§£å†³æ–¹æ¡ˆ"}},[_._v("#")]),_._v(" 5.1 é¢„å‡åº“å­˜è§£å†³æ–¹æ¡ˆ")]),_._v(" "),e("p",[_._v("è§£å†³æ–¹æ¡ˆï¼š")]),_._v(" "),e("p",[_._v("1ã€å•†å“æœåŠ¡å¯åŠ¨æ—¶å¯åŠ¨æ—¶æŠŠåº“å­˜å­˜å…¥Redis")]),_._v(" "),e("p",[_._v("2ã€ä¸‹å•æ—¶redisé¢„å‡å¤„ç†")]),_._v(" "),e("p",[_._v("å•†å“æœåŠ¡å¯åŠ¨æ—¶é¢„çƒ­ç§’æ€å•†å“åº“å­˜ä¿¡æ¯")]),_._v(" "),e("p",[_._v("/**")]),_._v(" "),e("p",[_._v("* åŠ è½½æ‰€æœ‰çš„ç§’æ€æ´»åŠ¨å•†å“åº“å­˜åˆ°ç¼“å­˜redisä¸­")]),_._v(" "),e("p",[_._v("* @throws Exception")]),_._v(" "),e("p",[_._v("*/")]),_._v(" "),e("p",[_._v("@Override")]),_._v(" "),e("p",[_._v("public void afterPropertiesSet() throws Exception {")]),_._v(" "),e("p",[_._v("//todo  è·å–æ‰€æœ‰çš„ç§’æ€æ´»åŠ¨ä¸­å•†å“")]),_._v(" "),e("p",[_._v("FlashPromotionParam promotion = flashPromotionProductDao.getFlashPromotion(null);")]),_._v(" "),e("p",[_._v("Date now = new Date();")]),_._v(" "),e("p",[_._v("Date endDate = promotion.getEndDate();//ç»“æŸæ—¶é—´")]),_._v(" "),e("p",[_._v("final Long expired = endDate.getTime()-now.getTime();//å‰©ä½™æ—¶é—´")]),_._v(" "),e("p",[_._v("//ç§’æ€å•†å“åº“å­˜ç¼“å­˜åˆ°redis")]),_._v(" "),e("p",[_._v("promotion.getRelation().stream().forEach((item)->{")]),_._v(" "),e("p",[_._v("â€‹    redisOpsUtil().setIfAbsent(")]),_._v(" "),e("p",[_._v("â€‹        RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + item.getProductId()")]),_._v(" "),e("p",[_._v("â€‹        , item.getFlashPromotionCount()")]),_._v(" "),e("p",[_._v("â€‹        , expired")]),_._v(" "),e("p",[_._v("â€‹        , TimeUnit.MILLISECONDS);")]),_._v(" "),e("p",[_._v("});")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[e("em",[_._v("DBå‡åº“å­˜å‰ å…ˆåœ¨redisé¢„å‡åº“å­˜")])]),_._v(" "),e("p",[_._v("private boolean preDecrRedisStock(Long productId,Long promotionId) {")]),_._v(" "),e("p",[_._v("â€‹    Long stock = redisOpsUtil.decr(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),_._v(" "),e("p",[_._v("â€‹    if (stock < 0) {")]),_._v(" "),e("p",[_._v("â€‹")]),_._v(" "),e("p",[_._v("â€‹     return false;")]),_._v(" "),e("p",[_._v("â€‹    }")]),_._v(" "),e("p",[_._v("â€‹    return true;")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("â€‹    //é¢„å‡åº“å­˜")]),_._v(" "),e("p",[_._v("â€‹    if(!preDecrRedisStock(productId,product.getFlashPromotionRelationId())){")]),_._v(" "),e("p",[_._v('â€‹      return CommonResult.failed("ä¸‹å•å¤±è´¥,å·²ç»æŠ¢è´­å®Œäº†");')]),_._v(" "),e("p",[_._v("â€‹")]),_._v(" "),e("p",[e("strong",[_._v("é—®é¢˜ï¼š redisåº“å­˜0  è¿˜éœ€è¦redisæ ¡éªŒå—ï¼Ÿ")])]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370503-226aaa09-b3f0-4e66-8220-ff91a41d6ba2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("em",[e("strong",[_._v("é—®é¢˜ï¼š")])])]),_._v(" "),e("p",[e("em",[e("strong",[_._v("å¦‚æœé¢„å‡åº“å­˜æˆåŠŸåï¼Œæ‰£å‡åº“å­˜ä¹‹å‰ç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œéœ€è¦è¡¥å›ä¹‹å‰é¢„å‡çš„åº“å­˜ã€‚")])])]),_._v(" "),e("h2",{attrs:{id:"_5-2-é¢„å‡åº“å­˜åå¼‚å¸¸ä¹‹å°‘å–"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-é¢„å‡åº“å­˜åå¼‚å¸¸ä¹‹å°‘å–"}},[_._v("#")]),_._v(" "),e("strong",[_._v("5.2 é¢„å‡åº“å­˜åå¼‚å¸¸ä¹‹å°‘å–")])]),_._v(" "),e("p",[e("em",[e("strong",[_._v("é¢„å‡åº“å­˜æˆåŠŸåï¼Œéœ€è¦è¡¥å›ä¹‹å‰é¢„å‡çš„åº“å­˜ï¼Œå¦åˆ™å‡ºç°å°‘å–")])])]),_._v(" "),e("p",[_._v("} catch (Exception e) {")]),_._v(" "),e("p",[_._v('log.error("æ¶ˆæ¯å‘é€å¤±è´¥:error msg:{}",e.getMessage(),e.getCause());')]),_._v(" "),e("p",[_._v("/*")]),_._v(" "),e("p",[_._v("* è¿˜åŸé¢„å‡åº“å­˜")]),_._v(" "),e("p",[_._v("*/")]),_._v(" "),e("p",[_._v("incrRedisStock(productId);")]),_._v(" "),e("p",[_._v("/*")]),_._v(" "),e("p",[_._v("* æ¸…é™¤æ‰æœ¬åœ°guavacacheå·²ç»å”®å®Œçš„æ ‡è®°")]),_._v(" "),e("p",[_._v("*/")]),_._v(" "),e("p",[_._v("cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),_._v(" "),e("p",[_._v("//é€šçŸ¥æœåŠ¡ç¾¤,æ¸…é™¤æœ¬åœ°å”®ç½„æ ‡è®°ç¼“å­˜")]),_._v(" "),e("p",[_._v("if(shouldPublishCleanMsg(productId)) {")]),_._v(" "),e("p",[_._v('â€‹    redisOpsUtil.publish("cleanNoStockCache", productId);')]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v('result.put("orderStatus",-1);')]),_._v(" "),e("p",[_._v('return CommonResult.failed(result,"ä¸‹å•å¤±è´¥");')]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("//è¿˜åŸåº“å­˜")]),_._v(" "),e("p",[_._v("public void incrRedisStock(Long productId){")]),_._v(" "),e("p",[_._v("if(redisOpsUtil.hasKey(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId)){")]),_._v(" "),e("p",[_._v("â€‹    redisOpsUtil.incr(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("Long stock = redisOpsUtil.decr(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),_._v(" "),e("p",[_._v("if (stock < 0) {")]),_._v(" "),e("p",[_._v("/*")]),_._v(" "),e("p",[_._v("* è¿˜åŸç¼“å­˜é‡Œçš„åº“å­˜ï¼Œæ€è€ƒè¿™é‡ŒåŠ å›æ¥çš„ç›®çš„ï¼")]),_._v(" "),e("p",[_._v("*/")]),_._v(" "),e("p",[_._v("incrRedisStock(productId);")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[e("strong",[_._v("é¢„å‡åº“å­˜å°äº0æ—¶å€™ï¼Œéœ€è¦å›è¡¥ã€‚å¦‚æœä¸å›è¡¥çš„è¯ï¼Œä¸Šé¢å¼‚å¸¸å›è¡¥çš„åº“å­˜å°±çœ‹ä¸è§ï¼Œé€ æˆ")])]),_._v(" "),e("p",[e("strong",[_._v("å°‘å–ï¼")])]),_._v(" "),e("p",[_._v("æ¯”å¦‚ 3ä¸ªçº¿ç¨‹ T1,T2,T3 é¢„å‡åº“å­˜ï¼Œå½“å‰åº“å­˜ä¸º1ï¼›")]),_._v(" "),e("p",[_._v("T1é¢„å‡åº“å­˜æˆåŠŸ  åº“å­˜=0ï¼›")]),_._v(" "),e("p",[_._v("T2,T3 é¢„å‡å¤±è´¥   åº“å­˜ = -2ï¼›")]),_._v(" "),e("p",[_._v("T1å›è¡¥åº“å­˜    ï¼Œ åº“å­˜=-1ï¼›")]),_._v(" "),e("p",[_._v("æ­¤æ—¶æ— æ³•è¿›è¡Œåº“å­˜æ‰£å‡ï¼Œå…¶å®åº“å­˜æ˜¯æœ‰ä¸€ä¸ªå•†å“çš„ï¼Œæ‰€ä»¥æ‰£å‡ä¹Ÿè¦å›è¡¥ã€‚")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370565-393e7a12-1992-412a-b119-0b07834e229d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_27%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370525-862ff732-5707-4a3c-ba1d-0bd4c40437b8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_34%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370558-7ba108fd-7bcd-4928-b459-435510531e35.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("strong",[_._v("å…¶å®ç°åœ¨æ˜¯æœ‰ä¸€ä¸ª åº“å­˜ï¼Œæ‰€ä»¥é¢„å‡åº“å­˜å¤±è´¥ä¹Ÿéœ€è¦å›è¡¥ ï¼Œé˜²æ­¢ å‡ºç° å°‘å–ï¼ï¼ï¼")])]),_._v(" "),e("h1",{attrs:{id:"_6-å”®ç½„æ ¡éªŒ"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-å”®ç½„æ ¡éªŒ"}},[_._v("#")]),_._v(" 6.å”®ç½„æ ¡éªŒ")]),_._v(" "),e("p",[_._v("å¦‚æœå•†å“å·²ç»å”®ç½„ï¼Œæµé‡æ²¡æœ‰å¿…è¦è¿›å…¥redisåšé¢„å‡ï¼Œå¯ä»¥æå‰è¿›è¡Œæ ¡éªŒã€‚")]),_._v(" "),e("h2",{attrs:{id:"_6-1-localcacheç¼“å­˜å”®ç½„æ ‡è¯†"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-localcacheç¼“å­˜å”®ç½„æ ‡è¯†"}},[_._v("#")]),_._v(" 6.1   Localcacheç¼“å­˜å”®ç½„æ ‡è¯†")]),_._v(" "),e("p",[_._v("é¦–å…ˆé€šè¿‡æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰åº“å­˜çš„æ ‡å¿—")]),_._v(" "),e("p",[_._v("Boolean localcache = cache.getCache(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),_._v(" "),e("p",[_._v("if(localcache != null && localcache){")]),_._v(" "),e("p",[_._v('return CommonResult.failed("å•†å“å·²ç»å”®ç½„,è¯·è´­ä¹°å…¶å®ƒå•†å“!");')]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("//ä»redisç¼“å­˜å½“ä¸­å–å‡ºå½“å‰è¦è´­ä¹°çš„å•†å“åº“å­˜")]),_._v(" "),e("p",[_._v("Integer stock = redisOpsUtil.get(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId,Integer.class);")]),_._v(" "),e("p",[_._v("if(stock == null || stock <= 0){")]),_._v(" "),e("p",[_._v("cache.setLocalCache(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId,true);")]),_._v(" "),e("p",[_._v('return CommonResult.failed("å•†å“å·²ç»å”®ç½„,è¯·è´­ä¹°å…¶å®ƒå•†å“!");')]),_._v(" "),e("p",[e("strong",[_._v("é¢„å‡å•†å“å‰æå‰æ ¡éªŒ å”®ç½„æ ‡è¯†")])]),_._v(" "),e("p",[_._v("CommonResult commonResult = confirmCheck(productId,memberId,token);")]),_._v(" "),e("p",[_._v("â€‹    if(commonResult.getCode() == 500){")]),_._v(" "),e("p",[_._v("â€‹      return commonResult;")]),_._v(" "),e("p",[_._v("â€‹")]),_._v(" "),e("p",[_._v("â€‹")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370445-85fc35e2-048a-4d4e-adf2-c079898faccc.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_19%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("h2",{attrs:{id:"-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[_._v("#")])]),_._v(" "),e("h3",{attrs:{id:"-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#-3"}},[_._v("#")])]),_._v(" "),e("h2",{attrs:{id:"_6-2-rediså‘å¸ƒè®¢é˜…åŒæ­¥é›†ç¾¤å”®ç½„æ ‡è¯†"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-rediså‘å¸ƒè®¢é˜…åŒæ­¥é›†ç¾¤å”®ç½„æ ‡è¯†"}},[_._v("#")]),_._v(" "),e("strong",[_._v("6.2  Rediså‘å¸ƒè®¢é˜…åŒæ­¥é›†ç¾¤å”®ç½„æ ‡è¯†")])]),_._v(" "),e("p",[e("strong",[_._v("Rediså‘å¸ƒè®¢é˜…æ¨¡å¼ é€šçŸ¥å…¶å®ƒåº”ç”¨æœ¬åœ°cacheçš„ åº“å­˜æ ‡å¿—è¿›è¡ŒåŒæ­¥ä¿®æ”¹")])]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370426-54c8704f-155b-4108-9043-311f2c37092d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370438-bd3ef6a1-fa4c-4e19-8ba1-3d092c39cfe7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("p",[e("strong",[_._v("å‘å¸ƒè®¢é˜…æ¼”ç¤ºå®ä¾‹")])]),_._v(" "),e("p",[_._v("ä»¥ä¸‹å®ä¾‹æ¼”ç¤ºäº†å‘å¸ƒè®¢é˜…æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚åœ¨æˆ‘ä»¬å®ä¾‹ä¸­æˆ‘ä»¬åˆ›å»ºäº†è®¢é˜…é¢‘é“åä¸º "),e("strong",[_._v("redisChat")]),_._v(":")]),_._v(" "),e("p",[_._v("redis 127.0.0.1:6379> SUBSCRIBE redisChat")]),_._v(" "),e("p",[_._v("Reading messages... (press Ctrl-C to quit)")]),_._v(" "),e("ol",[e("li",[e("p",[_._v('"subscribe"')])]),_._v(" "),e("li",[e("p",[_._v('"redisChat"')])]),_._v(" "),e("li",[e("p",[_._v("(integer) 1")])])]),_._v(" "),e("p",[_._v("ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆé‡æ–°å¼€å¯ä¸ª redis å®¢æˆ·ç«¯ï¼Œç„¶ååœ¨åŒä¸€ä¸ªé¢‘é“ redisChat å‘å¸ƒä¸¤æ¬¡æ¶ˆæ¯ï¼Œè®¢é˜…è€…å°±èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚")]),_._v(" "),e("p",[_._v('redis 127.0.0.1:6379> PUBLISH redisChat "Redis is a great caching technique"')]),_._v(" "),e("p",[_._v("(integer) 1")]),_._v(" "),e("p",[_._v('redis 127.0.0.1:6379> PUBLISH redisChat "Learn redis by runoob.com"')]),_._v(" "),e("p",[_._v("(integer) 1")]),_._v(" "),e("p",[_._v("# è®¢é˜…è€…çš„å®¢æˆ·ç«¯ä¼šæ˜¾ç¤ºå¦‚ä¸‹æ¶ˆæ¯")]),_._v(" "),e("ol",[e("li",[e("p",[_._v('"message"')])]),_._v(" "),e("li",[e("p",[_._v('"redisChat"')])]),_._v(" "),e("li",[e("p",[_._v('"Redis is a great caching technique"')])]),_._v(" "),e("li",[e("p",[_._v('"message"')])]),_._v(" "),e("li",[e("p",[_._v('"redisChat"')])]),_._v(" "),e("li",[e("p",[_._v('"Learn redis by runoob.c')])])]),_._v(" "),e("p",[e("strong",[_._v("Rediså®ç°å‘å¸ƒè®¢é˜…åŒæ­¥ å„ä¸ªåº”ç”¨ç¼“å­˜çš„é€»è¾‘ï¼š")])]),_._v(" "),e("p",[_._v("public class RedisConifg {")]),_._v(" "),e("p",[_._v("1.åˆ›å»ºchannnel Topic")]),_._v(" "),e("p",[_._v("@Bean")]),_._v(" "),e("p",[_._v("ChannelTopic channelTopic(){")]),_._v(" "),e("p",[_._v('return new ChannelTopic("cleanNoStockCache");')]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("2.åˆ›å»ºç›‘å¬å™¨å’Œå‘å¸ƒè€…")]),_._v(" "),e("p",[_._v("public class RedisOpsUtil {")]),_._v(" "),e("p",[_._v("public void publish(String channel,Object message){")]),_._v(" "),e("p",[_._v("redisTemplate.convertAndSend(channel,message);")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("@Slf4j")]),_._v(" "),e("p",[_._v("public class RedisChannelListener implements MessageListener {")]),_._v(" "),e("p",[_._v("@Autowired")]),_._v(" "),e("p",[_._v("private LocalCache localCache;")]),_._v(" "),e("p",[_._v("@Override")]),_._v(" "),e("p",[_._v("public void onMessage(Message message, @Nullable byte[] pattern) {")]),_._v(" "),e("p",[_._v('â€‹    log.info("sub message ğŸ˜ƒ channel[cleanNoStockCache] !");')]),_._v(" "),e("p",[_._v("â€‹    String productId = new String(message.getBody(), StandardCharsets.UTF_8);")]),_._v(" "),e("p",[_._v("â€‹    localCache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("ol",[e("li",[_._v("RedisMessageListenerContainerç›‘å¬å®¹å™¨æ¥å°†è®¢é˜…è€…ä¸æŒ‡å®šé¢‘é“ç»‘å®š,é›†æˆç›‘å¬å™¨å’ŒChanel")])]),_._v(" "),e("p",[_._v("@Bean")]),_._v(" "),e("p",[_._v("public RedisMessageListenerContainer redisMessageListenerContainer(){")]),_._v(" "),e("p",[_._v("RedisMessageListenerContainer container = new RedisMessageListenerContainer();")]),_._v(" "),e("p",[_._v("container.setConnectionFactory(connectionFactory);")]),_._v(" "),e("p",[_._v("container.addMessageListener(messageListenerAdapter(),channelTopic());")]),_._v(" "),e("p",[_._v("return container;")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("@Bean")]),_._v(" "),e("p",[_._v("MessageListenerAdapter messageListenerAdapter(){")]),_._v(" "),e("p",[_._v("return new MessageListenerAdapter(redisChannelListener());")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("@Bean")]),_._v(" "),e("p",[_._v("RedisChannelListener redisChannelListener(){")]),_._v(" "),e("p",[_._v("return new RedisChannelListener();")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("@Bean")]),_._v(" "),e("p",[_._v("ChannelTopic channelTopic(){")]),_._v(" "),e("p",[_._v('return new ChannelTopic("cleanNoStockCache")')]),_._v(" "),e("p",[e("strong",[_._v("æ‰£å‡åº“å­˜å¤±è´¥ å‘å¸ƒåŒæ­¥é›†ç¾¤å”®ç½„æ ‡å¿—æ¶ˆæ¯")])]),_._v(" "),e("p",[_._v("} catch (Exception e) {")]),_._v(" "),e("p",[_._v('log.error("create order failure:)",e.getMessage(),e.getCause());')]),_._v(" "),e("p",[_._v("//è¡¥å›å·²ç»å‡æ‰çš„åº“å­˜!")]),_._v(" "),e("p",[_._v("incrRedisStock(productId);")]),_._v(" "),e("p",[_._v("//é€šçŸ¥æœåŠ¡ç¾¤,æ¸…é™¤æœ¬åœ°å”®ç½„æ ‡è®°ç¼“å­˜")]),_._v(" "),e("p",[_._v('redisOpsUtil.publish("cleanNoStockCache",productId);')]),_._v(" "),e("p",[_._v('throw new BusinessException("åˆ›å»ºè®¢å•å¤±è´¥!");')]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("p",[_._v("Rediså‘å¸ƒè®¢é˜…å¹¶æ²¡æœ‰ä¿è¯æ‰€æœ‰è®¢é˜…è€…ä¸€å®šæ”¶åˆ°æ¶ˆæ¯ï¼Œæ²¡æœ‰æ¶ˆæ¯é‡è¯•æœºåˆ¶,ä¸æ˜¯Ackæœºåˆ¶ã€‚æ‰€ä»¥æ²¡æ³•ä¿è¯å¼ºä¸€è‡´æ€§ã€‚åªèƒ½é€šè¿‡google guava cache å¤±æ•ˆæœºåˆ¶ï¼ˆ60sï¼‰æ¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370400-c40291f7-4694-4b0b-93cd-9f56906a277d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_35%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("h1",{attrs:{id:"_7-rocketmqåŒæ­¥åº“å­˜"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-rocketmqåŒæ­¥åº“å­˜"}},[_._v("#")]),_._v(" 7.RocketMQåŒæ­¥åº“å­˜")]),_._v(" "),e("p",[e("strong",[_._v("redis æ‰£å‡åº“å­˜æˆåŠŸ ï¼ŒDBæäº¤å¼‚å¸¸ï¼Œå›è¡¥åº“å­˜ä¹‹å‰å‘ç”ŸJVMå´©æºƒï¼Œ redisä¸DBä¸ä¸€è‡´ å‡ºç°å°‘å–ã€‚å¦‚ä½•åŒæ­¥redisä¸DBä¸€è‡´ã€‚")])]),_._v(" "),e("p",[_._v("è§£å†³æ–¹æ¡ˆï¼š")]),_._v(" "),e("p",[_._v("redisé¢„å‡åº“å­˜å°‘äº0çš„æ—¶å€™  å‘é€æ¶ˆæ¯ç»™MQ è¿›è¡ŒåŒæ­¥æ•°æ®åº“å’Œredisçš„åº“å­˜ã€‚")]),_._v(" "),e("p",[e("strong",[_._v("1.ç¬¬ä¸€æ¬¡å‘ç° åº“å­˜å°äº0 ï¼Œå‘å¸ƒåŒæ­¥ DBå’Œredisåº“å­˜çš„ æŒ‡ä»¤ç»™MQ")])]),_._v(" "),e("p",[e("strong",[_._v("2.è®°å½• æ ‡è®°ï¼Œè¡¨ç¤ºå·²ç»å‘å¸ƒè¿‡ åŒæ­¥æŒ‡ä»¤ï¼Œåç»­è¯·æ±‚æ— éœ€ç»§ç»­è¯·æ±‚åŒæ­¥ã€‚")])]),_._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225370562-5f27a29a-4c3d-4b5b-acd4-2b27b33fd5be.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_39%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),_._v(" "),e("h2",{attrs:{id:"_7-1-åº“å­˜åŒæ­¥å®ç°ç»†èŠ‚"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-åº“å­˜åŒæ­¥å®ç°ç»†èŠ‚"}},[_._v("#")]),_._v(" "),e("strong",[_._v("7.1 åº“å­˜åŒæ­¥å®ç°ç»†èŠ‚")])]),_._v(" "),e("ol",[e("li",[e("strong",[_._v("å‘é€åŒæ­¥åº“å­˜çš„å»¶è¿Ÿæ¶ˆæ¯")])])]),_._v(" "),e("p",[_._v("public class OrderMessageSender {")]),_._v(" "),e("p",[_._v("/**")]),_._v(" "),e("p",[_._v("* å‘é€å»¶æ—¶åŒæ­¥åº“å­˜æ¶ˆæ¯ï¼Œ60sååŒæ­¥åº“å­˜")]),_._v(" "),e("p",[_._v("* @param productId")]),_._v(" "),e("p",[_._v("* @param promotionId")]),_._v(" "),e("p",[_._v("* @return")]),_._v(" "),e("p",[_._v("*/")]),_._v(" "),e("p",[_._v("public boolean sendStockSyncMessage(Long productId,Long promotionId){")]),_._v(" "),e("p",[_._v('Message message = MessageBuilder.withPayload(productId+":"+promotionId).build();')]),_._v(" "),e("p",[_._v('SendResult result = rocketMQTemplate.syncSend("stock-sync",message,5000,5);')]),_._v(" "),e("p",[_._v("return SendStatus.SEND_OK == result.getSendStatus();")]),_._v(" "),e("p",[_._v("}")]),_._v(" "),e("ol",[e("li",[e("strong",[_._v("å¼€å§‹åŒæ­¥DBä¸redisåº“å­˜")])])]),_._v(" "),e("p",[_._v("@Slf4j")]),_._v(" "),e("p",[_._v("@Component")]),_._v(" "),e("p",[_._v('@RocketMQMessageListener(topic = "stock-sync",consumerGroup = "stock-sync-worker")')]),_._v(" "),e("p",[_._v("public class StockSyncReciever implements RocketMQListener"),e("String",[_._v(" {")])],1),_._v(" "),e("p",[_._v("@Autowired")]),_._v(" "),e("p",[_._v("private RedisOpsUtil redisOpsUtil;")]),_._v(" "),e("p",[_._v("@Autowired")]),_._v(" "),e("p",[_._v("private PmsProductFeignApi stockManageFeignApi;")]),_._v(" "),e("p",[_._v("@Override")]),_._v(" "),e("p",[_._v("public void onMessage(String message) {")]),_._v(" "),e("p",[_._v('â€‹    String[] param = message.split("ğŸ˜Š;')]),_._v(" "),e("p",[_._v("â€‹    if(param.length <= 1){")]),_._v(" "),e("p",[_._v('â€‹      log.error("åº“å­˜åŒæ­¥ï¼Œæ¶ˆè´¹æ¶ˆæ¯å‚æ•°ä¸å®Œæ•´!");')]),_._v(" "),e("p",[_._v("â€‹      return;")]),_._v(" "),e("p",[_._v("â€‹    }")]),_._v(" "),e("p",[_._v("â€‹    Long productID = Long.parseLong(param[0]);")]),_._v(" "),e("p",[_._v("â€‹    Long promotionId =  Long.parseLong(param[1]);")]),_._v(" "),e("p",[_._v("â€‹    /*")]),_._v(" "),e("p",[_._v("â€‹     * æœ‰æ­¤æ ‡è®°,ä»£è¡¨è¿˜æ²¡æœ‰åšåŒæ­¥,éœ€è¦åŒæ­¥DBåˆ°redis,å¦‚æœæ ‡è®°è¢«åˆ é™¤è¯´æ˜è‚¯å®šä¸ä¹…å‰")]),_._v(" "),e("p",[_._v("â€‹     * åˆšåˆšåŒæ­¥è¿‡ã€‚åŒæ­¥è¿‡å°±æ²¡æœ‰å¿…è¦å¤šæ¬¡å»åŒæ­¥ï¼Œå¤šæ¡åŒæ­¥å»¶æ—¶æ¶ˆæ¯æ¥æºäºé«˜å¹¶å‘ä¸‹å‘é€")]),_._v(" "),e("p",[_._v("â€‹     * åº“å­˜åŒæ­¥æ¶ˆæ¯ã€‚è¿™é‡Œä»»ç„¶æ²¡æœ‰åŠæ³•ç»å¯¹é¿å…å¤šæ¬¡æŸ¥è¯¢DBï¼Œä½†æ˜¯å¯ä»¥å¤§å¤§å‡å°‘æŸ¥è¯¢æ¬¡æ•°.")]),_._v(" "),e("p",[_._v("â€‹     */")]),_._v(" "),e("p",[_._v("â€‹    if(redisOpsUtil.hasKey(RedisKeyPrefixConst.STOCK_REFRESHED_MESSAGE_PREFIX + promotionId)){")]),_._v(" "),e("p",[_._v('â€‹      log.info("start sync mysql stock to redis");')]),_._v(" "),e("p",[_._v("â€‹      //todo åŒæ­¥ä¸€ä¸‹åº“å­˜åˆ°ç¼“å­˜å½“ä¸­")]),_._v(" "),e("p",[_._v("â€‹      Integer stock = stockManageFeignApi.selectStock(productID,promotionId).getData();")]),_._v(" "),e("p",[_._v("â€‹      if(stock > 0){")]),_._v(" "),e("p",[_._v("â€‹        //é‡ç½®åº“å­˜")]),_._v(" "),e("p",[_._v("â€‹        redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productID,stock);")]),_._v(" "),e("p",[_._v("â€‹        //åˆ é™¤åŒæ­¥æ ‡è®°")]),_._v(" "),e("p",[_._v("â€‹        redisOpsUtil.delete(RedisKeyPrefixConst.STOCK_REFRESHED_MESSAGE_PREFIX + promotionId);")]),_._v(" "),e("p",[_._v("â€‹      }")]),_._v(" "),e("p",[_._v("â€‹    }")]),_._v(" "),e("p",[_._v("}")])])}),[],!1,null,null,null);e.default=s.exports}}]);