(window.webpackJsonp=window.webpackJsonp||[]).push([[436],{852:function(e,_,t){"use strict";t.r(_);var r=t(1),v=Object(r.a)({},(function(){var e=this,_=e._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("h1",{attrs:{id:"ç§’æ€ç³»ç»Ÿå‡åº“å­˜ä»¥åŠé˜²åˆ·é™æµå®æˆ˜"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#ç§’æ€ç³»ç»Ÿå‡åº“å­˜ä»¥åŠé˜²åˆ·é™æµå®æˆ˜"}},[e._v("#")]),e._v(" "),_("strong",[e._v("ç§’æ€ç³»ç»Ÿå‡åº“å­˜ä»¥åŠé˜²åˆ·é™æµå®æˆ˜")])]),e._v(" "),_("h1",{attrs:{id:"_1-åŒæ­¥ä¸‹å•"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_1-åŒæ­¥ä¸‹å•"}},[e._v("#")]),e._v(" 1.åŒæ­¥ä¸‹å•")]),e._v(" "),_("p",[e._v("ä¼˜ç‚¹ï¼š æ–¹æ¡ˆç®€å•ï¼Œåœ¨è¿æ¥ä¸å¤šçš„æƒ…å†µå“åº”è¿…é€Ÿ")]),e._v(" "),_("p",[e._v("ç¼ºç‚¹ï¼š éšç€è¯·æ±‚è¿æ¥å¢å¤šï¼ŒDBæ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚é˜»å¡ï¼Œæ•´ä¸ªæœåŠ¡é›†ç¾¤æ— æ³•æ­£å¸¸æä¾›æœåŠ¡ã€‚")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442069-2a6e76f1-0a02-4e71-a54d-cdd5c2ed9468.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_36%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_2-rocketmqå¼‚æ­¥ä¸‹å•"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-rocketmqå¼‚æ­¥ä¸‹å•"}},[e._v("#")]),e._v(" 2.RocketMQå¼‚æ­¥ä¸‹å•")]),e._v(" "),_("p",[e._v("RocketMQæ¶æ„å›¾")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442036-097ad1fd-fa14-48ef-a81c-e2fd6a3e977f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[e._v("MQæ¶ˆæ¯é˜Ÿåˆ—å¤„ç†è®¢å•ï¼š")]),e._v(" "),_("p",[e._v("å¼‚æ­¥ï¼šå¯ä»¥å¤„ç†æ›´å¤šè®¢å•")]),e._v(" "),_("p",[e._v("å‰Šå³°ï¼šæ›´é«˜ååèƒ½åŠ›å’Œæ¶ˆæ¯å †ç§¯èƒ½åŠ›")]),e._v(" "),_("p",[e._v("=ã€‹åœ¨å¤„ç†é«˜å¹¶å‘è¯·æ±‚æ—¶æ€§èƒ½å’Œååé‡æ›´é«˜")]),e._v(" "),_("p",[e._v("å¼‚æ­¥ä¸‹å•æµç¨‹ï¼š")]),e._v(" "),_("ul",[_("li",[_("p",[e._v("ä¸šåŠ¡ç±»æ„å»ºè®¢å•DTO")])]),e._v(" "),_("li",[_("p",[e._v("æ¶ˆæ¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯è¿”å›åˆ›å»ºè®¢å•ä¸­")])]),e._v(" "),_("li",[_("p",[e._v("å®¢æˆ·ç«¯è½®è®­è®¢å•çŠ¶æ€")])]),e._v(" "),_("li",[_("p",[e._v("æ¶ˆè´¹æ¶ˆè´¹è€… æ¶ˆè´¹è®¢å•æ¶ˆæ¯ï¼Œç”Ÿæˆè®¢å•ï¼Œä¿®æ”¹è®¢å•çŠ¶æ€")])]),e._v(" "),_("li",[_("p",[e._v("ä¸‹å•å®Œæˆ")])])]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225443018-ae79c8e3-7174-43d3-b8e3-34ac124ee062.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_42%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_2-1-mqç”Ÿäº§è€…"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-mqç”Ÿäº§è€…"}},[e._v("#")]),e._v(" 2.1 MQç”Ÿäº§è€…")]),e._v(" "),_("p",[_("strong",[e._v("ç”Ÿäº§è€…å‘é€æ¶ˆæ¯")])]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Component")]),e._v(" "),_("p",[e._v("public class OrderMessageSender {")]),e._v(" "),_("p",[e._v(".......")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* å‘é€è®¢å•æ¶ˆæ¯")]),e._v(" "),_("p",[e._v("* @return")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("public boolean sendCreateOrderMsg(OrderMessage message){")]),e._v(" "),_("p",[e._v('SendResult result = rocketMQTemplate.syncSend(asyncOrderTopic+":"+ORDERTAG,message);')]),e._v(" "),_("p",[e._v("return SendStatus.SEND_OK == result.getSendStatus();")]),e._v(" "),_("p",[_("strong",[e._v("ä¸šåŠ¡å‘é€è®¢å•å¤„ç†")])]),e._v(" "),_("ul",[_("li",[_("strong",[e._v("å‘é€æ¶ˆæ¯")])]),e._v(" "),_("li",[_("strong",[e._v("å‘é€æˆåŠŸ=ã€‹è®¾ç½® è®¢å•çŠ¶æ€ ï¼š 1-ã€‹ä¸‹å•ä¸­   -1-ã€‹å¤±è´¥   å¤§äº1->è®¢ å•å·")])]),e._v(" "),_("li",[_("strong",[e._v("å‘é€å¤±è´¥ =ã€‹è¿˜åŸé¢„å‡åº“å­˜ï¼Œåˆ é™¤æœ¬åœ° å”®ç½„æ ‡è¯†ï¼Œå‘é€æ¶ˆæ¯åŒæ­¥æ ‡****è¯†")])])]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Service")]),e._v(" "),_("p",[e._v("public class SecKillOrderServiceImpl implements SecKillOrderService {")]),e._v(" "),_("p",[e._v("..............")]),e._v(" "),_("p",[e._v("OrderMessage orderMessage = new OrderMessage();")]),e._v(" "),_("p",[e._v("orderMessage.setOrder(order);")]),e._v(" "),_("p",[e._v("orderMessage.setOrderItem(orderItem);")]),e._v(" "),_("p",[e._v("orderMessage.setFlashPromotionRelationId(product.getFlashPromotionRelationId());")]),e._v(" "),_("p",[e._v("orderMessage.setFlashPromotionLimit(product.getFlashPromotionLimit());")]),e._v(" "),_("p",[e._v("orderMessage.setFlashPromotionEndDate(product.getFlashPromotionEndDate());")]),e._v(" "),_("p",[e._v("Map<String,Object> result = new HashMap<>();")]),e._v(" "),_("p",[e._v("List"),_("OmsOrderItem",[e._v(" itemList = new ArrayList<>();")])],1),e._v(" "),_("p",[e._v("itemList.add(orderItem);")]),e._v(" "),_("p",[e._v('result.put("order",order);')]),e._v(" "),_("p",[e._v('result.put("orderItemList",itemList);')]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v("boolean sendStatus = orderMessageSender.sendCreateOrderMsg(orderMessage);")]),e._v(" "),_("p",[e._v("if(sendStatus){")]),e._v(" "),_("p",[e._v("â€‹    /*")]),e._v(" "),_("p",[e._v("â€‹     * æ‰“ä¸Šæ’é˜Ÿçš„æ ‡è®°")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v('â€‹    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId + ":" + productId')]),e._v(" "),_("p",[e._v("â€‹        ,Integer.toString(1),60, TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v("â€‹    /*")]),e._v(" "),_("p",[e._v("â€‹     * ä¸‹å•æ–¹å¼0->åŒæ­¥ä¸‹å•,1->å¼‚æ­¥ä¸‹å•æ’é˜Ÿä¸­,-1->ç§’æ€å¤±è´¥")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v('â€‹    result.put("orderStatus",1);')]),e._v(" "),_("p",[e._v("}else{")]),e._v(" "),_("p",[e._v("â€‹    /*")]),e._v(" "),_("p",[e._v("â€‹     * è¿˜åŸé¢„å‡åº“å­˜")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v("â€‹    incrRedisStock(productId);")]),e._v(" "),_("p",[e._v("â€‹    /*")]),e._v(" "),_("p",[e._v("â€‹     * æ¸…é™¤æ‰æœ¬åœ°guavacacheå·²ç»å”®å®Œçš„æ ‡è®°")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v("â€‹    cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),e._v(" "),_("p",[e._v("â€‹    //é€šçŸ¥æœåŠ¡ç¾¤,æ¸…é™¤æœ¬åœ°å”®ç½„æ ‡è®°ç¼“å­˜")]),e._v(" "),_("p",[e._v("â€‹    if(shouldPublishCleanMsg(productId)){")]),e._v(" "),_("p",[e._v('â€‹      redisOpsUtil.publish("cleanNoStockCache",productId);')]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v('â€‹    result.put("orderStatus",-1);')]),e._v(" "),_("p",[e._v('â€‹    return CommonResult.failed(result,"ä¸‹å•å¤±è´¥");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("} catch (Exception e) {")]),e._v(" "),_("p",[e._v('log.error("æ¶ˆæ¯å‘é€å¤±è´¥:error msg:{}",e.getMessage(),e.getCause());')]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* è¿˜åŸé¢„å‡åº“å­˜")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("incrRedisStock(productId);")]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* æ¸…é™¤æ‰æœ¬åœ°guavacacheå·²ç»å”®å®Œçš„æ ‡è®°")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),e._v(" "),_("p",[e._v("//é€šçŸ¥æœåŠ¡ç¾¤,æ¸…é™¤æœ¬åœ°å”®ç½„æ ‡è®°ç¼“å­˜")]),e._v(" "),_("p",[e._v("if(shouldPublishCleanMsg(productId)) {")]),e._v(" "),_("p",[e._v('â€‹    redisOpsUtil.publish("cleanNoStockCache", productId);')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v('result.put("orderStatus",-1);')]),e._v(" "),_("p",[e._v('return CommonResult.failed(result,"ä¸‹å•å¤±è´¥");')]),e._v(" "),_("h2",{attrs:{id:"_2-1-æ¶ˆæ¯æ¶ˆè´¹åˆ›å»ºè®¢å•"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-æ¶ˆæ¯æ¶ˆè´¹åˆ›å»ºè®¢å•"}},[e._v("#")]),e._v(" 2.1  æ¶ˆæ¯æ¶ˆè´¹åˆ›å»ºè®¢å•")]),e._v(" "),_("p",[e._v("åˆ›å»ºæ¶ˆæ¯æ¶ˆè´¹è€…")]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Component")]),e._v(" "),_("p",[e._v('@RocketMQMessageListener(topic = "${rocketmq.luban.asyncOrderTopic}",consumerGroup = "${rocketmq.luban.asyncOrderGroup}")')]),e._v(" "),_("p",[e._v("public class AscynCreateOrderReciever implements RocketMQListener"),_("OrderMessage",[e._v(" {")])],1),e._v(" "),_("p",[e._v("æ¶ˆè´¹æ¶ˆæ¯")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* å¼‚æ­¥ä¸‹å•æ¶ˆè´¹æ¶ˆæ¯")]),e._v(" "),_("p",[e._v("* @param orderMessage")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public void onMessage(OrderMessage orderMessage) {")]),e._v(" "),_("p",[e._v('log.info("listen the rocketmq message");')]),e._v(" "),_("p",[e._v("Long memberId = orderMessage.getOrder().getMemberId();")]),e._v(" "),_("p",[e._v("Long productId = orderMessage.getOrderItem().getProductId();")]),e._v(" "),_("p",[e._v("//è®¢å•ç¼–å·,åˆ†åº“åˆ†è¡¨ä¸ç”¨è¯¥ç¼–å·åšè®¢å•ç»“æœæ ‡è®°")]),e._v(" "),_("p",[e._v("String orderSn = orderMessage.getOrder().getOrderSn();")]),e._v(" "),_("p",[e._v("Integer limit = orderMessage.getFlashPromotionLimit();")]),e._v(" "),_("p",[e._v("Date endDate = orderMessage.getFlashPromotionEndDate();")]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v("â€‹    Long orderId = secKillOrderService.asyncCreateOrder(orderMessage.getOrder(),orderMessage.getOrderItem(),orderMessage.getFlashPromotionRelationId());")]),e._v(" "),_("p",[e._v("â€‹    //æ›´æ”¹æ’é˜Ÿæ ‡è®°çŠ¶æ€,ä»£è¡¨å·²ç»ä¸‹å•æˆåŠŸ,IDè®¾ç½®ä¸ºsnowflakeå,ç”¨IDä½œä¸ºçŠ¶æ€æ ‡è®°")]),e._v(" "),_("p",[e._v("â€‹    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId")]),e._v(" "),_("p",[e._v('â€‹        + ":" + productId,orderId.toString(),60L, TimeUnit.SECONDS);')]),e._v(" "),_("p",[e._v("â€‹    /*")]),e._v(" "),_("p",[e._v("â€‹     * è®¾ç½®ç”¨æˆ·è´­ä¹°æ¬¡æ•°,(ä¸é™åˆ¶è´­ä¹°æ¬¡æ•°äº†,éœ€è¦å¯è‡ªè¡Œæ”¾å¼€æ­¤å¤„,")]),e._v(" "),_("p",[e._v("â€‹     * å¹¶åœ¨secKillOrderService.checkConfirmä¸­åŠ å…¥éªŒè¯)")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v('â€‹    /*Integer rebuy = redisOpsUtil.get(RedisKeyPrefixConst.MEMBER_BUYED_MIAOSHA_PREFIX + memberId + ":" + productId,Integer.class);')]),e._v(" "),_("p",[e._v("â€‹    if(rebuy != null){")]),e._v(" "),_("p",[e._v('â€‹      redisOpsUtil.decr(RedisKeyPrefixConst.MEMBER_BUYED_MIAOSHA_PREFIX + memberId + ":" + productId);')]),e._v(" "),_("p",[e._v("â€‹    }else{")]),e._v(" "),_("p",[e._v("â€‹      //å‰©ä½™æ—¶é—´")]),e._v(" "),_("p",[e._v("â€‹      Date now = new Date();")]),e._v(" "),_("p",[e._v("â€‹      Long expired = endDate.getTime()-now.getTime();")]),e._v(" "),_("p",[e._v("â€‹      //æ‰“ä¸Šè´­ä¹°æ¬¡æ•°æ ‡è®°")]),e._v(" "),_("p",[e._v('â€‹      redisOpsUtil.set(RedisKeyPrefixConst.MEMBER_BUYED_MIAOSHA_PREFIX + memberId + ":" + productId,limit-1')]),e._v(" "),_("p",[e._v("â€‹          ,expired,TimeUnit.MILLISECONDS);")]),e._v(" "),_("p",[e._v("â€‹    }*/")]),e._v(" "),_("p",[e._v("} catch (Exception e) {")]),e._v(" "),_("p",[e._v("â€‹    log.error(e.getMessage(),e.getCause());")]),e._v(" "),_("p",[e._v("â€‹    /*")]),e._v(" "),_("p",[e._v("â€‹     * ä¸‹å•å¤±è´¥")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v("â€‹    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId")]),e._v(" "),_("p",[e._v('â€‹        + ":" + productId,Integer.toString(-1),60L, TimeUnit.SECONDS);')]),e._v(" "),_("p",[e._v("â€‹    //è¿˜åŸé¢„å‡åº“å­˜")]),e._v(" "),_("p",[e._v("â€‹    secKillOrderService.incrRedisStock(productId);")]),e._v(" "),_("p",[e._v("â€‹    //æ¸…é™¤æ‰æœ¬åœ°guava-cacheå·²ç»å”®å®Œçš„æ ‡è®°")]),e._v(" "),_("p",[e._v("â€‹    cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),e._v(" "),_("p",[e._v("â€‹    //é€šçŸ¥æœåŠ¡ç¾¤,æ¸…é™¤æœ¬åœ°å”®ç½„æ ‡è®°ç¼“å­˜")]),e._v(" "),_("p",[e._v("â€‹    if(secKillOrderService.shouldPublishCleanMsg(productId)) {")]),e._v(" "),_("p",[e._v('â€‹      redisOpsUtil.publish("cleanNoStockCache", productId);')]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v("å…³äºæ¶ˆè´¹æ¶ˆæ¯å¼‚å¸¸ï¼š")]),e._v(" "),_("ol",[_("li",[e._v("æ¶ˆè´¹è€…åœ¨æœªæäº¤è®¢å•åˆ°dbä¹‹å‰å¼‚å¸¸ï¼Œéœ€è¦å›è¡¥åº“å­˜ã€‚")]),e._v(" "),_("li",[e._v("æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯å¹¶ä¸”æœªæäº¤è®¢å•åˆ°dbä¹‹å‰ï¼ŒJVMå´©æºƒã€‚ æœåŠ¡å™¨æœªæ”¶åˆ°æ¶ˆè´¹è€…ACKï¼Œç»§ç»­æŠ•é€’ã€‚")]),e._v(" "),_("li",[e._v("æ¶ˆè´¹è€…æäº¤è®¢å•ä¹‹åJVMå´©æºƒï¼ŒæœåŠ¡å™¨æœªæ”¶åˆ°æ¶ˆè´¹è€…ACKã€‚æ¶ˆæ¯ä¼šç»§ç»­æŠ•é€’ï¼Œæ­¤æ—¶éœ€è¦æ ¡éªŒæ¶ˆæ¯çš„å¹‚ç­‰æ€§ã€‚")])]),e._v(" "),_("p",[e._v("â€‹       æ¶ˆæ¯IDçš„å…¨å±€å”¯ä¸€æ€§")]),e._v(" "),_("p",[e._v("â€‹       æ¶ˆæ¯åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶é¦–å…ˆåˆ¤æ–­æ¶ˆæ¯IDæ˜¯å¦å·²ç»å­˜åœ¨DBï¼Œå­˜åœ¨çš„æ—¶å€™ç›´æ¥è¿”å›æˆåŠŸï¼Œå¦åˆ™ç»§ç»­åˆ›å»ºè®¢å•æ“ä½œã€‚")]),e._v(" "),_("h2",{attrs:{id:"_2-2-è®¢å•æˆåŠŸå‘é€å»¶è¿Ÿæ¶ˆæ¯ç­‰å¾…æ”¯ä»˜"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-è®¢å•æˆåŠŸå‘é€å»¶è¿Ÿæ¶ˆæ¯ç­‰å¾…æ”¯ä»˜"}},[e._v("#")]),e._v(" 2.2  è®¢å•æˆåŠŸå‘é€å»¶è¿Ÿæ¶ˆæ¯ç­‰å¾…æ”¯ä»˜")]),e._v(" "),_("p",[e._v("å»¶è¿Ÿæ¶ˆæ¯ ï¼š messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h")]),e._v(" "),_("p",[e._v("@Transactional")]),e._v(" "),_("p",[e._v("public Long asyncCreateOrder(OmsOrder order,OmsOrderItem orderItem,Long flashPromotionRelationId) {")]),e._v(" "),_("p",[e._v("//å‡åº“å­˜")]),e._v(" "),_("p",[e._v("Integer result = miaoShaStockDao.descStock(flashPromotionRelationId, 1);")]),e._v(" "),_("p",[e._v('log.info("å¼‚æ­¥ä¸‹å•å‡åº“å­˜æˆåŠŸ");')]),e._v(" "),_("p",[e._v("if (result <= 0) {")]),e._v(" "),_("p",[e._v('â€‹    throw new RuntimeException("æ²¡æŠ¢åˆ°ï¼");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v('log.info("å¼‚æ­¥ä¸‹å•å‡åº“å­˜æˆåŠŸ");')]),e._v(" "),_("p",[e._v("//æŸ¥è¯¢è®¢å•")]),e._v(" "),_("p",[e._v("//æ’å…¥è®¢å•è®°å½•")]),e._v(" "),_("p",[e._v("orderMapper.insertSelective(order);")]),e._v(" "),_("p",[e._v("//OrderItemå…³è”")]),e._v(" "),_("p",[e._v("orderItem.setOrderId(order.getId());")]),e._v(" "),_("p",[e._v("orderItem.setOrderSn(order.getOrderSn());")]),e._v(" "),_("p",[e._v("//æ’å…¥orderItem")]),e._v(" "),_("p",[e._v("orderItemMapper.insertSelective(orderItem);")]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* å¦‚æœè®¢å•åˆ›å»ºæˆåŠŸ,éœ€è¦å‘é€å®šæ—¶æ¶ˆæ¯,20minåå¦‚æœæ²¡æœ‰æ”¯ä»˜,åˆ™å–æ¶ˆå½“å‰è®¢å•,é‡Šæ”¾åº“å­˜")]),e._v(" "),_("p",[e._v("* 0")]),e._v(" "),_("p",[e._v("* */")]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v('â€‹    boolean sendStatus = orderMessageSender.sendTimeOutOrderMessage(order.getId() + ":" + flashPromotionRelationId + ":" + orderItem.getProductId());')]),e._v(" "),_("p",[e._v("â€‹    if (!sendStatus) {")]),e._v(" "),_("p",[e._v('â€‹      throw new RuntimeException("è®¢å•è¶…æ—¶å–æ¶ˆæ¶ˆæ¯å‘é€å¤±è´¥ï¼");')]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v("} catch (Exception e) {")]),e._v(" "),_("p",[e._v('â€‹    throw new RuntimeException("è®¢å•è¶…æ—¶å–æ¶ˆæ¶ˆæ¯å‘é€å¤±è´¥ï¼");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("return order.getId();")]),e._v(" "),_("h2",{attrs:{id:"_2-3-è¶…æ—¶å–æ¶ˆè®¢å•"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-è¶…æ—¶å–æ¶ˆè®¢å•"}},[e._v("#")]),e._v(" 2.3 è¶…æ—¶å–æ¶ˆè®¢å•")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* æ¶ˆè´¹ç›‘å¬rocketmq-è®¢å•è¶…æ—¶æ¶ˆæ¯")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Component")]),e._v(" "),_("p",[e._v('@RocketMQMessageListener(consumerGroup = "${rocketmq.luban.cancelGroup}", topic = "${rocketmq.luban.scheduleTopic}")')]),e._v(" "),_("p",[e._v("public class RocketMqCancelOrderReciever implements RocketMQListener"),_("String",[e._v(" {")])],1),e._v(" "),_("p",[e._v("@Autowired")]),e._v(" "),_("p",[e._v("private OmsPortalOrderService omsPortalOrderService;")]),e._v(" "),_("p",[e._v("@Autowired")]),e._v(" "),_("p",[e._v("private SecKillOrderService secKillOrderService;")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* å»¶æ—¶æ¶ˆæ¯,å–æ¶ˆè¶…æ—¶è®¢å•")]),e._v(" "),_("p",[e._v("* @param cancelId")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public void onMessage(String cancelId) {")]),e._v(" "),_("p",[e._v('â€‹    log.info("ç›‘å¬è¶…æ—¶è®¢å•ï¼š"+cancelId);')]),e._v(" "),_("p",[e._v("â€‹    if(StringUtils.isEmpty(cancelId)){")]),e._v(" "),_("p",[e._v("â€‹      return;")]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v('â€‹    Long orderId = Long.parseLong(cancelId.split("ğŸ˜Š[0]);')]),e._v(" "),_("p",[e._v('â€‹    Long promotionId = Long.parseLong(cancelId.split("ğŸ˜Š[1]);')]),e._v(" "),_("p",[e._v('â€‹    Long productId = Long.parseLong(cancelId.split("ğŸ˜Š[2]);')]),e._v(" "),_("p",[e._v("â€‹    try {")]),e._v(" "),_("p",[e._v("â€‹      //å–æ¶ˆçš„è®¢å•,é‡Šæ”¾DBåº“å­˜")]),e._v(" "),_("p",[e._v("â€‹      omsPortalOrderService.cancelOrder(orderId,promotionId);")]),e._v(" "),_("p",[e._v("â€‹      //å–æ¶ˆçš„è®¢å•-è¿˜åŸç¼“å­˜åº“å­˜")]),e._v(" "),_("p",[e._v("â€‹      secKillOrderService.incrRedisStock(productId);")]),e._v(" "),_("p",[e._v('â€‹      log.info("è®¢å•å–æ¶ˆï¼ŒorderId:{},productId:{}",orderId,productId);')]),e._v(" "),_("p",[e._v("â€‹    } catch (Exception e) {")]),e._v(" "),_("p",[e._v('â€‹      log.error("è®¢å•å–æ¶ˆå¼‚å¸¸ : è¿˜åŸåº“å­˜å¤±è´¥ï¼Œplease check:{}",e.getMessage(),e.getCause());')]),e._v(" "),_("p",[e._v("â€‹      throw new RuntimeException();//æŠ›å¼‚å¸¸å‡ºå»,rocketmqä¼šé‡æ–°æŠ•é€’")]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("ol",[_("li",[e._v("MQäº‹åŠ¡æ¶ˆæ¯")])]),e._v(" "),_("p",[e._v("RocketMQäº‹åŠ¡æ¶ˆæ¯æ¶æ„ï¼š")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442002-57060036-ee99-4a09-b972-b4b72ba300b7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("strong",[e._v("ä¸šåŠ¡åœºæ™¯ï¼š ä¸€èˆ¬é€‚ç”¨ä¸‹å•æˆåŠŸååˆ é™¤è´­ç‰©è½¦ ï¼Œè®¡ç®—ç§¯åˆ†")])]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v('@RocketMQTransactionListener(txProducerGroup = "${rocketmq.luban.transGroup}")')]),e._v(" "),_("p",[e._v("public class TransactionListenerImpl implements RocketMQLocalTransactionListener {")]),e._v(" "),_("p",[e._v("private ConcurrentHashMap<String, Integer> localTrans = new ConcurrentHashMap<String, Integer>();")]),e._v(" "),_("p",[e._v("private static int maxTryMums = 3;")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object orderDto) {")]),e._v(" "),_("p",[e._v('â€‹    log.info("------------RocketMQæ‰§è¡Œæœ¬åœ°è®¢å•åˆ›å»º-------------");')]),e._v(" "),_("p",[e._v("â€‹    String transId = (String)msg.getHeaders().get(RocketMQHeaders.PREFIX + RocketMQHeaders.TRANSACTION_ID);")]),e._v(" "),_("p",[e._v("â€‹    /**")]),e._v(" "),_("p",[e._v("â€‹     *")]),e._v(" "),_("p",[e._v("â€‹     * å†™ä½ çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œé€»è¾‘")]),e._v(" "),_("p",[e._v("â€‹     *")]),e._v(" "),_("p",[e._v("â€‹     * */")]),e._v(" "),_("p",[e._v("â€‹    //åˆ é™¤è´­ç‰©è½¦  è®¡ç®—è®¢å•ç§¯åˆ†")]),e._v(" "),_("p",[e._v("â€‹    localTrans.put(transId, 0);")]),e._v(" "),_("p",[e._v("â€‹    return RocketMQLocalTransactionState.UNKNOWN;")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {")]),e._v(" "),_("p",[e._v('â€‹    log.info("æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯checkLocalTransaction()æ–¹æ³•");')]),e._v(" "),_("p",[e._v("â€‹    RocketMQLocalTransactionState retState;")]),e._v(" "),_("p",[e._v("â€‹    String transId = (String)msg.getHeaders().get(RocketMQHeaders.PREFIX + RocketMQHeaders.TRANSACTION_ID);")]),e._v(" "),_("p",[e._v("â€‹     //æŸ¥è¯¢ è´­ç‰©è½¦æ˜¯å¦åˆ é™¤æˆåŠŸ")]),e._v(" "),_("p",[e._v("â€‹    //æŸ¥è¯¢ç§¯åˆ†è®¡ç®—æ˜¯å¦æˆåŠŸ")]),e._v(" "),_("p",[e._v("â€‹    int retryTimes = localTrans.get(transId);//äº‹åŠ¡recheckæ¬¡æ•°")]),e._v(" "),_("p",[e._v("â€‹    int isExists = 0;//è®¢å•æ˜¯å¦å·²ç»ç”Ÿæˆ")]),e._v(" "),_("p",[e._v("â€‹    if(retryTimes < maxTryMums && isExists > 0){")]),e._v(" "),_("p",[e._v("â€‹      retState = RocketMQLocalTransactionState.COMMIT;")]),e._v(" "),_("p",[e._v("â€‹      localTrans.remove(transId);")]),e._v(" "),_("p",[e._v("â€‹    }else if(retryTimes < maxTryMums && isExists == 0){")]),e._v(" "),_("p",[e._v("â€‹      localTrans.put(transId,retryTimes+1);")]),e._v(" "),_("p",[e._v("â€‹      retState = RocketMQLocalTransactionState.UNKNOWN;")]),e._v(" "),_("p",[e._v("â€‹    }else{")]),e._v(" "),_("p",[e._v("â€‹      retState = RocketMQLocalTransactionState.ROLLBACK;")]),e._v(" "),_("p",[e._v("â€‹      localTrans.remove(transId);")]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v('â€‹    log.info("------ !!!å›æŸ¥è®¢å•æ˜¯å¦æˆåŠŸæäº¤,msgTransactionId={}, TransactionState={} status={}", transId, retState, retryTimes);')]),e._v(" "),_("p",[e._v("â€‹    return retState;")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("static class MessageConvertHelper extends MappingJackson2MessageConverter {")]),e._v(" "),_("p",[e._v("â€‹    private final static MessageConvertHelper converter;")]),e._v(" "),_("p",[e._v("â€‹    static{")]),e._v(" "),_("p",[e._v("â€‹      converter = new MessageConvertHelper();")]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("p",[e._v("â€‹    public static Object convert(Message<?> message, Class<?> targetClass){")]),e._v(" "),_("p",[e._v("â€‹      return converter.convertFromInternal(message,targetClass,null);")]),e._v(" "),_("p",[e._v("â€‹    }")]),e._v(" "),_("ol",[_("li",[e._v("ç§’æ€ç³»ç»Ÿçš„å‹æµ‹")])]),e._v(" "),_("h2",{attrs:{id:"_4-1-æ‰¹é‡ç”Ÿæˆç”¨æˆ·è´¦æˆ·ä¿¡æ¯"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-æ‰¹é‡ç”Ÿæˆç”¨æˆ·è´¦æˆ·ä¿¡æ¯"}},[e._v("#")]),e._v(" 4.1 æ‰¹é‡ç”Ÿæˆç”¨æˆ·è´¦æˆ·ä¿¡æ¯")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442036-14539484-8ce2-49dd-9b77-e1d74ad5113a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442078-08f1809b-0011-4564-b9b0-2db12da43f21.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_51%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-2-æ‰¹é‡ç”Ÿæˆjwt-token"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-æ‰¹é‡ç”Ÿæˆjwt-token"}},[e._v("#")]),e._v(" 4.2 æ‰¹é‡ç”ŸæˆJWT token")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442030-7c9f2e53-5976-418b-93a0-6c1d1ff03f49.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_52%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442074-c3760f41-d53b-4e4a-82e9-f2d747e852c3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442210-81862fa7-551b-4ec9-a020-602e9061ce7c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_35%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442040-49c32116-4e8b-4387-994e-e0f65d0ef922.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-3-jmeterè®¾ç½®config-data"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-jmeterè®¾ç½®config-data"}},[e._v("#")]),e._v(" 4.3 Jmeterè®¾ç½®config Data")]),e._v(" "),_("p",[e._v("è®¾ç½®jwt tokenå˜é‡åï¼šAuthorization")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442140-4e784215-02c4-45d8-8661-6b890c7ba197.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_50%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-4-è®¾ç½®è¯·æ±‚head"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-è®¾ç½®è¯·æ±‚head"}},[e._v("#")]),e._v(" 4.4 è®¾ç½®è¯·æ±‚head")]),e._v(" "),_("p",[e._v("è®¾ç½®è¯·æ±‚å¤´")]),e._v(" "),_("p",[e._v("Authorizationï¼š ${Authorization}")]),e._v(" "),_("p",[e._v("Content-Typeï¼šapplication/json")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442172-d20b9d41-1b3d-42e7-8aee-5b4a5b826cbb.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-5-è®¾ç½®å¹¶å‘è¯·æ±‚æ•°"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-è®¾ç½®å¹¶å‘è¯·æ±‚æ•°"}},[e._v("#")]),e._v(" 4.5 è®¾ç½®å¹¶å‘è¯·æ±‚æ•°")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442066-d28b7cc2-af59-4a71-9587-0c62e18d36d5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_39%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:""}},[_("a",{staticClass:"header-anchor",attrs:{href:"#"}},[e._v("#")])]),e._v(" "),_("h2",{attrs:{id:"_4-6-è®¾ç½®è¯·æ±‚æŠ¥æ–‡ä½“"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-è®¾ç½®è¯·æ±‚æŠ¥æ–‡ä½“"}},[e._v("#")]),e._v(" 4.6 è®¾ç½®è¯·æ±‚æŠ¥æ–‡ä½“")]),e._v(" "),_("p",[e._v("è¯·æ±‚URL : http://localhost:8888/order/secKill/generateOrder")]),e._v(" "),_("p",[e._v("æ–¹æ³•ç±»å‹ï¼š post")]),e._v(" "),_("p",[e._v("æŠ¥æ–‡ä½“ï¼š {")]),e._v(" "),_("p",[e._v('"itemIds": [')]),e._v(" "),_("p",[e._v("27")]),e._v(" "),_("p",[e._v("],")]),e._v(" "),_("p",[e._v('"memberReceiveAddressId": 1,')]),e._v(" "),_("p",[e._v('"payType": 1,')]),e._v(" "),_("p",[e._v('"couponId":2,')]),e._v(" "),_("p",[e._v('"useIntegration": 100')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442063-19359122-01c4-4195-8fdc-c22758d41f64.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h1",{attrs:{id:"-2"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[e._v("#")])]),e._v(" "),_("h2",{attrs:{id:"_4-7-æ¸…ç†redisç¼“å­˜"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-æ¸…ç†redisç¼“å­˜"}},[e._v("#")]),e._v(" 4.7 æ¸…ç†redisç¼“å­˜")]),e._v(" "),_("p",[e._v("> flushdb")]),e._v(" "),_("h1",{attrs:{id:"-3"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#-3"}},[e._v("#")])]),e._v(" "),_("h2",{attrs:{id:"_4-8-æœåŠ¡å¯åŠ¨"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-æœåŠ¡å¯åŠ¨"}},[e._v("#")]),e._v(" 4.8  æœåŠ¡å¯åŠ¨")]),e._v(" "),_("p",[e._v("å…ˆåå¯åŠ¨ luban-auth  ,luban-gateway,luban-member,luban-product,luban-order.")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442210-9eb257e8-1cd2-42b7-96b3-68c2b3ec7397.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_51%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-9-å¼€å¯å‹æµ‹"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-å¼€å¯å‹æµ‹"}},[e._v("#")]),e._v(" 4.9 å¼€å¯å‹æµ‹")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442073-e360750c-c5bd-495a-ae68-86fa0f93bad7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("ol",[_("li",[e._v("ç§’æ€éªŒè¯ç æµç¨‹")])]),e._v(" "),_("h2",{attrs:{id:"_5-1-ç”ŸæˆéªŒè¯ç "}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-ç”ŸæˆéªŒè¯ç "}},[e._v("#")]),e._v(" 5.1 ç”ŸæˆéªŒè¯ç ")]),e._v(" "),_("h3",{attrs:{id:"_5-1-1-åˆ›å»ºéªŒè¯ç "}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-1-åˆ›å»ºéªŒè¯ç "}},[e._v("#")]),e._v(" 5.1.1 åˆ›å»ºéªŒè¯ç ")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* åˆ›å»ºéªŒè¯ç ")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("public static VerifyCodeInfo createVerifyCode() {")]),e._v(" "),_("p",[e._v("int width = 80;")]),e._v(" "),_("p",[e._v("int height = 32;")]),e._v(" "),_("p",[e._v("//create the image")]),e._v(" "),_("p",[e._v("BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);")]),e._v(" "),_("p",[e._v("Graphics g = image.getGraphics();")]),e._v(" "),_("p",[e._v("// set the background color")]),e._v(" "),_("p",[e._v("g.setColor(new Color(0xDCDCDC));")]),e._v(" "),_("p",[e._v("g.fillRect(0, 0, width, height);")]),e._v(" "),_("p",[e._v("// draw the border")]),e._v(" "),_("p",[e._v("g.setColor(Color.black);")]),e._v(" "),_("p",[e._v("g.drawRect(0, 0, width - 1, height - 1);")]),e._v(" "),_("p",[e._v("// create a random instance to generate the codes")]),e._v(" "),_("p",[e._v("Random rdm = new Random();")]),e._v(" "),_("p",[e._v("// make some confusion")]),e._v(" "),_("p",[e._v("for (int i = 0; i < 50; i++) {")]),e._v(" "),_("p",[e._v("â€‹    int x = rdm.nextInt(width);")]),e._v(" "),_("p",[e._v("â€‹    int y = rdm.nextInt(height);")]),e._v(" "),_("p",[e._v("â€‹    g.drawOval(x, y, 0, 0);")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("// generate a random code")]),e._v(" "),_("p",[e._v("String verifyCode = generateVerifyCode(rdm);")]),e._v(" "),_("p",[e._v("g.setColor(new Color(0, 100, 0));")]),e._v(" "),_("p",[e._v('g.setFont(new Font("Candara", Font.BOLD, 24));')]),e._v(" "),_("p",[e._v("g.drawString(verifyCode, 8, 24);")]),e._v(" "),_("p",[e._v("g.dispose();")]),e._v(" "),_("p",[e._v("//æŠŠéªŒè¯ç å­˜åˆ°redisä¸­")]),e._v(" "),_("p",[e._v("Integer result = calc(verifyCode);")]),e._v(" "),_("p",[e._v("if (result == null) {")]),e._v(" "),_("p",[e._v("â€‹    return null;")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("//è¾“å‡ºç»“æœ")]),e._v(" "),_("p",[e._v("return new VerifyCodeInfo(image,result);")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("h3",{attrs:{id:"_5-1-2-éªŒè¯ç ç­”æ¡ˆå­˜å‚¨åœ¨redis"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-2-éªŒè¯ç ç­”æ¡ˆå­˜å‚¨åœ¨redis"}},[e._v("#")]),e._v(" 5.1.2 éªŒè¯ç ç­”æ¡ˆå­˜å‚¨åœ¨redis")]),e._v(" "),_("p",[e._v('@RequestMapping(value="/verifyCode", method=RequestMethod.GET)')]),e._v(" "),_("p",[e._v("@ResponseBody")]),e._v(" "),_("p",[e._v("public CommonResult getVerifyCode(HttpServletRequest request,")]),e._v(" "),_("p",[e._v("â€‹                 HttpServletResponse response,")]),e._v(" "),_("p",[e._v('â€‹                 @RequestParam("productId") Long productId,')]),e._v(" "),_("p",[e._v('â€‹                 @RequestHeader("memberId") Long memberId){')]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v("â€‹    VerifyCodeImgUtil.VerifyCodeInfo imageInfo = VerifyCodeImgUtil.createVerifyCode();")]),e._v(" "),_("p",[e._v('â€‹    log.info("éªŒè¯ç ç­”æ¡ˆ:{}",imageInfo.getResult());')]),e._v(" "),_("p",[e._v("â€‹    //todo éªŒè¯ç ç­”æ¡ˆå†™å…¥åˆ°redis")]),e._v(" "),_("p",[e._v('â€‹    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_VERIFY_CODE_PREFIX + memberId + ":" + productId //å…¨å±€å”¯ä¸€ID')]),e._v(" "),_("p",[e._v("â€‹        ,imageInfo.getResult()")]),e._v(" "),_("p",[e._v("â€‹        ,300")]),e._v(" "),_("p",[e._v("â€‹        ,TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v('â€‹    response.setHeader("Content-Type", "image/jpeg");')]),e._v(" "),_("p",[e._v("â€‹    OutputStream out = response.getOutputStream();")]),e._v(" "),_("p",[e._v('â€‹    ImageIO.write(imageInfo.getBufferedImage(), "JPEG", out);')]),e._v(" "),_("p",[e._v("â€‹    out.flush();")]),e._v(" "),_("p",[e._v("â€‹    out.close();")]),e._v(" "),_("p",[e._v("â€‹    return null;")]),e._v(" "),_("p",[e._v("â€‹    /**")]),e._v(" "),_("p",[e._v("â€‹     * è¿”å›å›¾ç‰‡çš„base64ç¼–ç ,jsè§£ç æˆå›¾ç‰‡")]),e._v(" "),_("p",[e._v("â€‹     */")]),e._v(" "),_("p",[e._v("â€‹    /*ByteArrayOutputStream baos = new ByteArrayOutputStream();//ioæµ")]),e._v(" "),_("p",[e._v('â€‹    ImageIO.write(imageInfo.getBufferedImage(), "png", baos);//å†™å…¥æµä¸­')]),e._v(" "),_("p",[e._v("â€‹    byte[] bytes = baos.toByteArray();//è½¬æ¢æˆå­—èŠ‚")]),e._v(" "),_("p",[e._v("â€‹    BASE64Encoder encoder = new BASE64Encoder();")]),e._v(" "),_("p",[e._v("â€‹    String png_base64 =  encoder.encodeBuffer(bytes).trim();//è½¬æ¢æˆbase64ä¸²")]),e._v(" "),_("p",[e._v('â€‹    png_base64 = png_base64.replaceAll("\\n", "").replaceAll("\\r", "");//åˆ é™¤ \\r\\n')]),e._v(" "),_("p",[e._v("â€‹    return CommonResult.success(png_base64);*/")]),e._v(" "),_("p",[e._v("}catch(Exception e) {")]),e._v(" "),_("p",[e._v("â€‹    e.printStackTrace();")]),e._v(" "),_("p",[e._v('â€‹    return CommonResult.failed("ç§’æ€å¤±è´¥");')]),e._v(" "),_("h3",{attrs:{id:"_5-1-3-æµ‹è¯•éªŒè¯ç ç”Ÿæˆ"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-3-æµ‹è¯•éªŒè¯ç ç”Ÿæˆ"}},[e._v("#")]),e._v(" 5.1.3 æµ‹è¯•éªŒè¯ç ç”Ÿæˆ")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442074-9ba36259-9b96-443a-b0af-986aea369e62.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_5-2-æ ¡éªŒéªŒè¯ç "}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-æ ¡éªŒéªŒè¯ç "}},[e._v("#")]),e._v(" 5.2 æ ¡éªŒéªŒè¯ç ")]),e._v(" "),_("h3",{attrs:{id:"_5-2-1-æäº¤éªŒè¯ç "}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-1-æäº¤éªŒè¯ç "}},[e._v("#")]),e._v(" 5.2.1 æäº¤éªŒè¯ç ")]),e._v(" "),_("p",[e._v('@RequestMapping(value="/token", method=RequestMethod.GET)')]),e._v(" "),_("p",[e._v("@ResponseBody")]),e._v(" "),_("p",[e._v("public CommonResult getMiaoshaToken(HttpServletRequest request")]),e._v(" "),_("p",[e._v('â€‹    , @RequestParam("productId") Long productId')]),e._v(" "),_("p",[e._v('â€‹    , @RequestHeader("memberId") Long memberId')]),e._v(" "),_("p",[e._v("â€‹    , @RequestParam Integer verifyCode) {")]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* ç”¨redisé™æµï¼Œé™åˆ¶æ¥å£1åˆ†é’Ÿæœ€å¤šè®¿é—®10000æ¬¡")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("String requestURI = request.getRequestURI().toString();")]),e._v(" "),_("p",[e._v("Long requestNum = redisOpsUtil.incr(requestURI);")]),e._v(" "),_("p",[e._v("if (requestNum == 1) {")]),e._v(" "),_("p",[e._v("â€‹    redisOpsUtil.expire(requestURI,60, TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v("} else if (requestNum > 10000) {")]),e._v(" "),_("p",[e._v('â€‹    return CommonResult.failed("è®¿é—®è¶…è½½ï¼Œè¯·ç¨åå†è¯•");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v('String verifyCodeKey = RedisKeyPrefixConst.MIAOSHA_VERIFY_CODE_PREFIX + memberId + ":" + productId;')]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* æ ¡éªŒéªŒè¯ç ï¼Œé˜²æ­¢æ¥å£è¢«åˆ·")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("Integer redisCode = redisOpsUtil.get(verifyCodeKey,Integer.class);")]),e._v(" "),_("p",[e._v("if(StringUtils.isEmpty(redisCode) || !redisCode.equals(verifyCode)) {")]),e._v(" "),_("p",[e._v('â€‹    return CommonResult.failed("éªŒè¯ç é”™è¯¯");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("//éªŒè¯æˆåŠŸ,åˆ é™¤è¯¥éªŒè¯ç ")]),e._v(" "),_("p",[e._v("redisOpsUtil.delete(verifyCodeKey);")]),e._v(" "),_("p",[e._v("//todo åˆ›å»ºtoken")]),e._v(" "),_("p",[e._v("String token = MD5.md5(UUID.randomUUID().toString());")]),e._v(" "),_("p",[e._v('log.info("miaosha token:{}",token);')]),e._v(" "),_("p",[e._v('redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_TOKEN_PREFIX + memberId + ":" + productId')]),e._v(" "),_("p",[e._v("â€‹      ,token")]),e._v(" "),_("p",[e._v("â€‹      ,300")]),e._v(" "),_("p",[e._v("â€‹      ,TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v("return CommonResult.success(toke")]),e._v(" "),_("h3",{attrs:{id:"_5-2-2-æ ¡éªŒéªŒè¯ç ç­”æ¡ˆ"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-2-æ ¡éªŒéªŒè¯ç ç­”æ¡ˆ"}},[e._v("#")]),e._v(" 5.2.2  æ ¡éªŒéªŒè¯ç ç­”æ¡ˆ")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442340-f08f6c1c-7a8c-4de3-a603-ad61eb2e4ea5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})])])}),[],!1,null,null,null);_.default=v.exports}}]);